# Triggered by Nooks after merchant payment. Runs EAS build for Android + iOS with merchant branding.
name: Nooks-triggered build
on:
  workflow_dispatch:
    inputs:
      merchant_id:
        required: true
        type: string
      logo_url:
        required: false
        type: string
        default: ""
      primary_color:
        required: false
        type: string
        default: "#0D9488"
      accent_color:
        required: false
        type: string
        default: "#0D9488"
      background_color:
        required: false
        type: string
        default: "#f5f5f4"
      menu_card_color:
        required: false
        type: string
        default: "#ffffff"
      text_color:
        required: false
        type: string
        default: "#1f2937"
      use_test_builds:
        description: "Use preview (Android APK) + ios-simulator so no Apple/Google dev accounts needed"
        required: false
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Require EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "::error::EXPO_TOKEN is not set. Do this:"
            echo "1. Get token: Open https://expo.dev → log in → Profile → Account settings → Access tokens → Create token (e.g. name 'GitHub Actions') → copy the token."
            echo "2. Set in GitHub: This repo → Settings → Secrets and variables → Actions → New repository secret → Name: EXPO_TOKEN, Value: (paste token) → Add secret."
            echo "Or from repo root: run  gh secret set EXPO_TOKEN  and paste the token when prompted."
            exit 1
          fi

      - name: Require build env secrets
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          API_URL: ${{ secrets.API_URL }}
          NOOKS_API_BASE_URL: ${{ secrets.NOOKS_API_BASE_URL }}
          MOYASAR_PUBLISHABLE_KEY: ${{ secrets.MOYASAR_PUBLISHABLE_KEY }}
        run: |
          missing=0
          [ -z "$SUPABASE_URL" ] && echo "::error::SUPABASE_URL is not set in GitHub repo secrets." && missing=1
          [ -z "$SUPABASE_ANON_KEY" ] && echo "::error::SUPABASE_ANON_KEY is not set in GitHub repo secrets." && missing=1
          [ -z "$API_URL" ] && echo "::error::API_URL is not set in GitHub repo secrets." && missing=1
          [ -z "$NOOKS_API_BASE_URL" ] && echo "::error::NOOKS_API_BASE_URL is not set in GitHub repo secrets." && missing=1
          [ -z "$MOYASAR_PUBLISHABLE_KEY" ] && echo "::error::MOYASAR_PUBLISHABLE_KEY is not set in GitHub repo secrets." && missing=1
          if [ "$missing" -eq 1 ]; then
            echo "Set missing secrets in: Repo -> Settings -> Secrets and variables -> Actions"
            exit 1
          fi

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Write .env for EAS
        run: |
          echo "EXPO_PUBLIC_MERCHANT_ID=${{ github.event.inputs.merchant_id }}" > .env
          echo "EXPO_PUBLIC_LOGO_URL=${{ github.event.inputs.logo_url }}" >> .env
          echo "EXPO_PUBLIC_PRIMARY_COLOR=${{ github.event.inputs.primary_color }}" >> .env
          echo "EXPO_PUBLIC_ACCENT_COLOR=${{ github.event.inputs.accent_color }}" >> .env
          echo "EXPO_PUBLIC_BACKGROUND_COLOR=${{ github.event.inputs.background_color }}" >> .env
          echo "EXPO_PUBLIC_MENU_CARD_COLOR=${{ github.event.inputs.menu_card_color }}" >> .env
          echo "EXPO_PUBLIC_TEXT_COLOR=${{ github.event.inputs.text_color }}" >> .env
          echo "EXPO_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "EXPO_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env
          echo "EXPO_PUBLIC_API_URL=${{ secrets.API_URL }}" >> .env
          echo "EXPO_PUBLIC_NOOKS_API_BASE_URL=${{ secrets.NOOKS_API_BASE_URL }}" >> .env
          echo "EXPO_PUBLIC_MOYASAR_PUBLISHABLE_KEY=${{ secrets.MOYASAR_PUBLISHABLE_KEY }}" >> .env
          if [ -n "${{ secrets.GOOGLE_MAPS_API_KEY }}" ]; then
            echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" >> .env
          else
            echo "GOOGLE_MAPS_API_KEY=" >> .env
            echo "::warning::GOOGLE_MAPS_API_KEY is not set. Android maps will run in fallback mode."
          fi
          echo "--- .env written ---"
          wc -l .env
          grep "PRIMARY_COLOR" .env

      - name: Build Android
        run: |
          if [ "${{ github.event.inputs.use_test_builds }}" = "true" ]; then
            eas build --platform android --profile preview --non-interactive --no-wait
          else
            eas build --platform android --non-interactive --no-wait
          fi

      - name: Build iOS
        run: |
          if [ "${{ github.event.inputs.use_test_builds }}" = "true" ]; then
            eas build --platform ios --profile ios-simulator --non-interactive --no-wait
          else
            eas build --platform ios --non-interactive --no-wait
          fi
